<!DOCTYPE html>
<html>
<head>
	<title>Unwanted Calls API</title>
	<meta name="theme-color" content="#037ed3">
	<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0"/>

	<!-- Icons -->
	<link rel="icon" href="/img/favicon.ico">

	<!-- Styles -->
	<!-- Fonts -->
	<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
	<!-- <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> -->
	<link rel="stylesheet" href="//cdn.materialdesignicons.com/1.2.65/css/materialdesignicons.min.css">

	<!-- Circle Reveal -->
	<!-- Clip Path Supported Browsers -->
	<link rel="stylesheet" type="text/css" href="/css/circle-reveal/circle-reveal.css">
	<!-- Legacy Support -->
	<link rel="stylesheet" href="/css/circle-reveal/circle-reveal-legacy.css">
	<!--[if IE]>
	<link rel="stylesheet" type="text/css" href="/css/circle-reveal/circle-reveal-legacy-only.css">
	<![endif]-->

	<link rel="stylesheet" href="./styles.css">
</head>
<body>
	<div class="card">
		<div class="card-title">Search The FCC's Unwanted Calls Public Data</div>
		<div class="card-subtitle">Enter the phone number to lookup against the database. Up to 24 hours behind the FCC.</div>
		<div class="phone-input">
			+1(<input type="text" name="area-code" id="area-code" oninput="input(event);">) <input type="text" name="first-digits" id="first-digits" oninput="input(event);"> - <input type="text" name="last-digits" id="last-digits" oninput="input(event);">
		</div>
	</div>

	<div class="results">
		<div class="card-title">Results</div>
		<div class="card-subtitle">Your results for the phone number you entered will appear here. Note that the FCC complaint database is fairly new and as a result, small.</div>
		<table class="table" id="table">
			<tr class="table-header">
				<td data-tooltip="The type of unwanted call the consumer is complaining about.">Phone Issues:</td>
				<td data-tooltip="The time that the consumer indicates the unwanted call occurred.">Time of Issue:</td>
				<td data-tooltip="The telephone number the consumer indicates appeared on their caller ID.">Caller ID Number:</td>
				<td data-tooltip="The telephone number the consumer indicates the advertiser provided during the call.">Advertiser Business Phone Number:</td>
				<td data-tooltip="The type of unwanted robocall the consumer identified (abandoned, autodialed live voice, prerecorded voice, or text message).">Type of Call or Message (Robocalls):</td>
				<td data-tooltip="The type of unwanted telemarketing call the consumer identified (abandoned, email, live voice, prerecorded voice, or text message).">Type of Call or Message (Telemarketing):</td>
				<td data-tooltip="The state that the consumer that received the call is located in.">State:</td>
				<td data-tooltip="The date the consumer states the indicated violation occurred.">Date (Ticket Date of Issue):</td>
				<td data-tooltip="The date the complaint was submitted to the FCC.">Date (Ticket Created):</td>
			</tr>
			<tr class="table-item" id="no-data">
				<td>No Data.</td>
				<td></td> 
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
		</table>
		<!-- <ul class="list">
			<li class="list-item" id="empty-list">Enter a phone number.</li>
		</ul> -->
	</div>

	<script src="./papaparse.min.js"></script>
	<script type="text/javascript">
		Object.size = function(obj) {
			var size = 0, key;
			for (key in obj) {
				if (obj.hasOwnProperty(key)) size++;
			}
			return size;
		};
		buffer = [];
		// Parse Data into Objects
		file = "./data.csv";
		Papa.parse(file, {
			download: true,
			header: true,
			complete: function(results) {
				data = results.data;
				console.log("Finished:", results.data);
				if (buffer.length > 0) {
					for (var i = buffer.length - 1; i >= 0; i--) {
						checkForPhone(buffer[i]);
					};
				};
				delete buffer;
			}
		});

		// Check for Params in URL
		if (/\?/.test(document.URL)) {
			params = decodeURI(document.URL).match(/\?phone=((\+1)?[\s-]*\(?(\d+)\)?[\s-]*(\d+)[\s-]*(\d+))/i);
			var phone = params[1];

			// document.getElementById('input').value = phone.replace(/(\+1)?[\s-]*\(?(\d+)\)?[\s-]*(\d+)[\s-]*(\d+)/, "$2-$3-$4");
			checkForPhone(phone.replace(/(\+1)?[\s-]*\(?(\d+)\)?[\s-]*(\d+)[\s-]*(\d+)/, "$2-$3-$4"));
		};

		// Check for phone
		function checkForPhone(p) {
			if (typeof data === "undefined") {
				buffer.push(p);
			} else {
				var results = [];
				for (var i = data.length - 1; i >= 0; i--) {
					c = data[i]["Caller ID Number"];
					a = data[i]["Advertiser Business Phone Number"];
					if (c == p || a == p) {
						results.push(i);
					};
				};
				output(results);
				return results;
			};
		}
		function output(results) {
			var noData = document.getElementById("no-data");
			if (noData != null) {
				noData.remove();
			};
			var tb = document.getElementById("table");
			for (var i = results.length - 1; i >= 0; i--) {
				var tr = document.createElement("tr");
				tr.classList.add("table-item");
				for (var ik = 0; ik < Object.size(data[results[i]]); ik++) {
					var k = Object.getOwnPropertyNames(data[results[i]])[ik];
					var td = document.createElement("td");
					td.innerHTML = data[results[i]][k];
					tr.appendChild(td);
				};
				tb.appendChild(tr);
			};
		}

		areaCodeEle = document.getElementById("area-code");
		firstDigitsEle = document.getElementById("first-digits");
		lastDigitsEle = document.getElementById("last-digits");
		// Input
		function input(event) {
			console.log(event);
			if (areaCodeEle.value.length == 3 && firstDigitsEle.value.length == 3 && lastDigitsEle.value.length == 4) {
				checkForPhone(areaCodeEle.value + "-" + firstDigitsEle.value + "-" + lastDigitsEle.value);
			} else if (event.target.id == "area-code" && event.target.value.length == 3) {
				firstDigitsEle.focus();
			} else if (event.target.id == "first-digits" && event.target.value.length == 3) {
				lastDigitsEle.focus();
			}
		}
	</script>
</body>
</html>